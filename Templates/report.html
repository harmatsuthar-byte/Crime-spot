<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crime Spot â€“ Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
  <style>
    #mapPicker {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="hidden lg:flex flex-col w-64 bg-[#F8FBFC] shadow-lg">
      <div class=" mt-3 bg-[#F8FBFC] border-b flex justify-between items-center px-4">
        <a href="/dashboard"><img src="/static/image/logo.png" alt=""></a>
      </div>
      <nav class="flex-1 bg-[#F8FBFC] p-6 space-y-4">
        <a href="/" class="block px-4 py-2 transition-all duration-500 bg-[#F6F1F1] rounded hover:bg-[#CF9CA0]"><i
            class="text-[18px] ri-dashboard-horizontal-line"></i> Dashboard</a>
        <a href="/map" class="block px-4 py-2 transition-all bg-[#F6F1F1] duration-500 rounded hover:bg-[#CF9CA0]"><i
            class="text-[18px] ri-road-map-line"></i> Crime Map</a>
        <a href="/report" class="block px-4 py-2 rounded bg-red-800 text-white font-semibold"><i
            class="m-1 text-[18px] ri-survey-line"></i> Report Crime</a>
        <a href="/awareness"
          class="block px-4 py-2 transition-all duration-500 bg-[#F6F1F1] rounded hover:bg-[#CF9CA0]"><i
            class="text-[18px] ri-megaphone-line"></i> Awareness</a>
      </nav>
      <div class="w-[250px] flex align-center bg-[#F8FBFC] justify-center mb-6">
        <a href="/admin_login" class="block underline  text-center  mt-[100px] transition-all duration-500 ">
          Continue as Admin <i class="ri-contract-right-line"></i></a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:flex-1 p-6 overflow-hidden">
      <div class="flex">
        <h2 class="text-3xl font-medium mb-6">Anonymous Crime Report</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        {% if category in ["success_report", "error_report"] %}
        <div id="flash-message"
          class="bg-green-200 border border-green-400 text-green-700 px-4 py-2 rounded relative ms-4 mb-4">
          {{ message }}
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
        {% endwith %}
      </div>
      <div class="flex flex-col lg:flex-row h-full">
        <iframe class="hidden lg:block lg:w-1/2 h-full"
          src="https://lottie.host/embed/a7839032-6366-4b4e-8be3-1be456437bb0/vx1vSmFw2i.lottie">
        </iframe>

        <form method="POST" action="/report"
          class="lg:w-1/2 bg-white h-[500px] p-6 rounded-xl shadow mt-7 space-y-4 relative">
          <div>
            <label class="block font-semibold mb-1" for="category">Crime Type</label>
            <select id="category" name="category" class="w-full p-3 border rounded-md" required>
              <option value="">Select crime type</option>
              <option value="Theft">Theft</option>
              <option value="Assault">Assault</option>
              <option value="Robbery">Robbery</option>
              <option value="Vandalism">Vandalism</option>
              <option value="Cybercrime">Cybercrime</option>
              <option value="Drug Offense">Drug Offense</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block font-semibold mb-1">Location</label>
            <input id="locationInput" name="locationInput" type="text"
              class="w-full p-3 border rounded-md bg-gray-100 cursor-pointer"
              placeholder="Click to pick location from map" readonly onclick="openMapModal()">
          </div>

          <input type="hidden" id="latitude" name="latitude">
          <input type="hidden" id="longitude" name="longitude">
          <div>
            <label class="block font-semibold mb-1" for="description">Description</label>
            <textarea id="description" name="description" rows="5" class="w-full p-3 border rounded-md"
              placeholder="Describe the incident..." required></textarea>
          </div>
          <input type="hidden" name="city" id="cityInput">

          <button type="submit" onclick="return validateForm()"
            class="bg-red-800 text-white font-semibold text-[18px] px-6 py-3 rounded-md hover:bg-red-900 transition">
            Submit Report
          </button>
        </form>

      </div>
    </main>

    <!-- Fullscreen Map Modal -->
    <div id="mapModal" class="fixed inset-0  hidden z-50 items-center justify-center">
      <div class="bg-white w-full h-full p-4 relative flex flex-col">
        <div class="flex justify-between items-center mb-2">
          <div class="flex gap-2">
            <h3 class="text-xl font-bold">Pick Location</h3>
            <!-- <div>
              <select id="baseMapSelect" class="border px-3 py-1 rounded text-sm">
                <option value="street" selected>Normal Map</option>
                <option value="satellite">Satellite View</option>
              </select>
            </div> -->
          </div>
          <button onclick="closeMapModal()" class="text-red-600 font-semibold">Close</button>
        </div>
        <div id="mapPicker" class="flex-1 rounded shadow"></div>
        <button onclick="confirmLocation()"
          class="mt-4 bg-red-600 text-white px-4 py-2 rounded self-end hover:bg-red-700">Confirm Location</button>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      setTimeout(() => {
        let msg = document.getElementById('flash-message');
        if (msg) msg.style.display = 'none';
      }, 3000);

      if (document.getElementById('flash-message')) {
        document.querySelector('form').reset();
        document.getElementById('locationInput').value = "";
      }

      let mapPicker, marker, streetLayer, satelliteLayer;

      function openMapModal() {
        document.getElementById('mapModal').classList.remove('hidden');
        setTimeout(() => {
          if (!mapPicker) {
            mapPicker = L.map('mapPicker').setView([26.2903, 73.0390], 14);
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapPicker);
            let esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

            let esriLabels = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');

            let satelliteWithLabels = L.layerGroup([esriSat, esriLabels]);
            L.control.layers({
              "Street View": streetLayer,
              "Satellite View": satelliteWithLabels
            }).addTo(mapPicker);

            mapPicker.on('click', function (e) {
              if (marker) mapPicker.removeLayer(marker);
              marker = L.marker(e.latlng).addTo(mapPicker);

              document.getElementById('latitude').value = e.latlng.lat;
              document.getElementById('longitude').value = e.latlng.lng;
              document.getElementById('locationInput').value =`${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;

              fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e.latlng.lat}&lon=${e.latlng.lng}&format=json`)
                .then(res => res.json())
                .then(data => {
                  let city = data.address.city || data.address.town || data.address.village || "Unknown";
                  document.getElementById("cityInput").value = city;
                })
                .catch(err => console.error("City fetch error:", err));
            });
          }
        }, 100);
      }

      function closeMapModal() {
        document.getElementById('mapModal').classList.add('hidden');
      }

      function confirmLocation() {
        if (document.getElementById('latitude').value) {
          closeMapModal();
        } else {
          alert("Please click on map to choose a location.");
        }
      }

      function validateForm() {
        if (!document.getElementById('latitude').value || !document.getElementById('longitude').value) {
          alert("Please pick a location on the map.");
          return false;
        }
        return true;
      }
    </script>
</body>

</html>